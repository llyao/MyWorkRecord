@using ClientApp.DB


@{
    ViewBag.Title = "构建主页";
}

@RenderPage("~/Views/Shared/_NavLeft.cshtml")
<div class="nav-right">
    <button class="btn btn-lg btn-info" id="buildBtn" style="width: 150px" type="button" onclick="build()">立即构建</button>
    <h1>版本记录</h1>
    <div style="width: 500px;overflow-y: auto; overflow-x: hidden; max-height: 600px">
        <div class="list-group">
            @foreach(BuildVersionTableData versionTableData in (ViewData["buildVersionTableDatas"] as List<BuildVersionTableData>))
            {
                if(versionTableData.ExitCode == 0)
                {
                    <a href="/Publish/History?cmd=@ViewData["cmd"]&versionID=@versionTableData.ID" style="background: url('../../Imgs/success.png') no-repeat right center;" class="list-group-item">
                        <h4 class="list-group-item-heading">版本：@versionTableData.ID</h4>
                        <p class="list-group-item-text">时间：@versionTableData.StartTimeFormat</p>
                    </a>
                }
                else
                {
                    <a href="/Publish/History?cmd=@ViewData["cmd"]&versionID=@versionTableData.ID" style="background: url('../../Imgs/fail.png') no-repeat right center;" class="list-group-item">
                        <h4 class="list-group-item-heading">版本：@versionTableData.ID</h4>
                        <p class="list-group-item-text">时间：@versionTableData.StartTimeFormat</p>
                    </a>
                }
            }
        </div>
    </div>
</div>

<script type="text/javascript">
    var timer = 0;
    getIsBuild();

    var isBuild = false;

    function build() {
        var params = GetParams();
        setIsBuilding(true);
        location.href = '/Publish/History?cmd=' + params["cmd"]; 
    };

    function setIsBuilding(building) {
        isBuild = building;
        var buildBtn = document.getElementById("buildBtn");
        if (building == false) {
            buildBtn.innerHTML = "立即构建";
        } else {
            buildBtn.innerHTML = "构建中..";
        }
    }

    function getIsBuild() {
        $.ajax({
            type: "Get",
            url: "/Publish/IsBuilding",
            data: {},
            success: function (data) {
                if (data.toString().toLocaleLowerCase() === "false") {
                    setIsBuilding(false);
                } else {
                    setIsBuilding(true);
                    clearInterval(timer);
                    timer = setInterval(running, 1000);
                }
            }
        });
    }

    function running() {
        $.ajax({
            type: "Get",
            url: "/Publish/IsBuilding",
            data: {},
            success: function (data) {
                if (data.toString().toLocaleLowerCase() === "false") {
                    setIsBuilding(false);
                    clearInterval(timer);
                } else {
                    setIsBuilding(true);
                }
            }
        });
    }

</script>

